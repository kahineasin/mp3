
<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    
    <title>想用cache保存mp3节省流量，但localStorage只能保存json, 最后没有成功</title>
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=0.46, maximum-scale=0.46">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0" />
    <!--<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta content="telephone=no" name="format-detection">-->

    <script  type="text/JavaScript"  src="script/jquery-1.7.1.min.js" ></script>
<!--    <script type="text/javascript" src="http://sellgirl.com/Content/js/sellgirl/EleResize.js"></script>
    <script type="text/javascript" src="http://sellgirl.com/Content/js/sellgirl/sellgirl.js"></script>-->
    
<!--    <script type="text/javascript" src="https://kahineasin.github.io/htmlAll/js/EleResize.js"></script>
    <script type="text/javascript" src="https://kahineasin.github.io/htmlAll/js/sellgirl.js"></script>
    <script type="text/javascript" src="https://kahineasin.github.io/htmlAll/js/pfUtil.js"></script>-->
    
    <script type="text/javascript" src="https://html.sellgirl.com/js/EleResize.js"></script>
    <script type="text/javascript" src="https://html.sellgirl.com/js/sellgirl.js"></script>
    <script type="text/javascript" src="https://html.sellgirl.com/js/pfUtil.js"></script>
    <!--<script  type="text/JavaScript"  src="script/pfUtil.js" ></script>-->
    <!--<script type="text/javascript" src="http://192.168.1.52:19005/Content/js/sellgirl/EleResize.js"></script>
    <script type="text/javascript" src="http://192.168.1.52:19005/Content/js/sellgirl/sellgirl.js"></script>-->
    <script type="text/javascript">
        $(function () {
            //背景图片
            //        sellgirl.backgroundImg(document.body, 'img/web_sasha_1920x1080_02.jpg', { w: 2300, h: 2300, s: { x: 0, y: 1150 }, e: { x: 2300, y: 1150} }, { thumbnail: 'img/web_sasha_thumbnail.jpg' });
            //            sellgirl.backgroundImg(document.body, 'img/web_sasha_1920x1080_02.jpg', { w: 2300, h: 2300, s: { x: 0, y: 1150 }, e: { x: 2300, y: 1150} }, null, { thumbnail: 'img/web_sasha_thumbnail.jpg' });
            sellgirl.backgroundImg(document.body, 'img/web_sasha_1920x1080_02.jpg', { w: 2300, h: 2300, s: { x: 0, y: 1150 }, e: { x: 2300, y: 1150 } }, { opacity: 0.5 }, { thumbnail: 'img/web_sasha_thumbnail.jpg' });
        });
    </script>

</head>
<body style="margin: 0px;">
    <div style="position:absolute;right:0px;top:0px;z-index:3"><a href="category.html">分类目录</a></div>
    <!--<canvas id="h5Image" style="position:absolute;z-index:2;"></canvas>-->
    <!--HTML5播放器,自动读取变量mp3FolderPath这个文件夹下的文件,自动识别是video还是audio,20180117-->
<!--<link rel="stylesheet" type="text/css" href="http://video.sellgirl.com/css/sellgirl_player_list.css">-->
<!-- <link rel="stylesheet" type="text/css" href="https://kahineasin.github.io/htmlAll/css/sellgirl_player_list.css"> -->
<link rel="stylesheet" type="text/css" href="https://html.sellgirl.com/css/sellgirl_player_list.css">

<script type="text/javascript" src="script/html5media.min.js"></script>

<div class="audioContainer">
    <div class="videoLayer">
    </div>
    <div class="sellgirl_player_list_container">
        <div class="sellgirl_player_list">
            <div class="sellgirl_player_list_toolbar">
                <!-- <a style="clear: both" href="javascript:;"  onclick="return nextPlayMode(this)">&lt;Order Repeat&gt;</a> -->
                <a href="javascript:;" id="nextPlayModeBtn" >&lt;随机播放&gt;</a> <a href="javascript:;" id="playNextBtn"
                    >&lt;下一首&gt;</a> <a id="selectSongBtn" href="javascript:;"
                        >&lt;选歌...&gt;</a> <a href="javascript:;" id="nextLrcModeBtn"
                            >&lt;单行歌词...&gt;</a>&nbsp;<a href="#" download="" id="downloadFileBtn">&lt;下载&gt;</a>
            </div>
            <hr />
            <div class="sellgirl_player_list_top" style="height: 69px;">
                <a href="#" src="./mp3/k/001.电灯胆_邓丽欣" lrc="./lrc/k/001.电灯胆_邓丽欣.lrc" sgidx="0" sgfmts="mp3">001.电灯胆 邓丽欣</a><a href="#" src="./mp3/k/002.电灯胆_Benjamin原声" lrc="./lrc/k/002.电灯胆_Benjamin原声.lrc" sgidx="1" sgfmts="mp3">002.电灯胆 Benjamin原声</a><a href="#" src="./mp3/k/003.电灯胆_邓丽欣_伴奏" lrc="./lrc/k/003.电灯胆_邓丽欣_伴奏.lrc" sgidx="2" sgfmts="mp3">003.电灯胆 邓丽欣 伴奏</a><a href="#" src="./mp3/k/004.Lady of the Pier(Du Mei Shin)" lrc="./lrc/k/004.Lady of the Pier(Du Mei Shin).lrc" sgidx="3" sgfmts="mp3">004.Lady of the Pier(Du Mei Shin)</a><a href="#" src="./mp3/k/005.Lady of the Pier(Du Mei Shin)_ben制作消音伴奏" lrc="./lrc/k/005.Lady of the Pier(Du Mei Shin)_ben制作消音伴奏.lrc" sgidx="4" sgfmts="mp3">005.Lady of the Pier(Du Mei Shin) ben制作消音伴奏</a>
                <a href="#" src="./mp3/k/006.小流星_汪苏泷_吴映洁" lrc="./lrc/k/006.小流星_汪苏泷_吴映洁.lrc" sgidx="5" sgfmts="mp3">006.小流星 汪苏泷 吴映洁</a><a href="#" src="./mp3/k/007.小流星_Nilisz" lrc="./lrc/k/007.小流星_Nilisz.lrc" sgidx="6" sgfmts="mp3">007.小流星 Nilisz</a><a href="#" src="./mp3/k/008.小流星_汪苏泷_吴映洁_伴奏" lrc="./lrc/k/008.小流星_汪苏泷_吴映洁_伴奏.lrc" sgidx="7" sgfmts="mp3">008.小流星 汪苏泷 吴映洁 伴奏</a><a href="#" src="./mp3/k/009.AliceGoodNight_秦旭章feat.Riin" lrc="./lrc/k/009.AliceGoodNight_秦旭章feat.Riin.lrc" sgidx="8" sgfmts="MP3">009.AliceGoodNight 秦旭章feat.Riin</a><a href="#" src="./mp3/k/010.AliceGoodNight_伴奏" lrc="./lrc/k/010.AliceGoodNight_伴奏.lrc" sgidx="9" sgfmts="mp3">010.AliceGoodNight 伴奏</a>
                <a href="#" src="./mp3/k/011.天真_弦子_伴奏" lrc="./lrc/k/011.天真_弦子_伴奏.lrc" sgidx="10" sgfmts="mp3">011.天真 弦子 伴奏</a><a href="#" src="./mp3/k/012.小幸运_伴奏" lrc="./lrc/k/012.小幸运_伴奏.lrc" sgidx="11" sgfmts="mp3">012.小幸运 伴奏</a><a href="#" src="./mp3/k/013.小幸运_ben" lrc="./lrc/k/013.小幸运_ben.lrc" sgidx="12" sgfmts="mp3">013.小幸运 ben</a>
                <a href="#" src="./mp3/k/014.可惜我是水瓶座_ben" lrc="./lrc/k/014.可惜我是水瓶座_ben.lrc" sgidx="13" sgfmts="mp3">014.可惜我是水瓶座_ben</a>
                <a href="#" src="./mp3/k/015.可惜我是水瓶座_伴奏" lrc="./lrc/k/014.可惜我是水瓶座_ben.lrc" sgidx="14" sgfmts="mp3">015.可惜我是水瓶座_伴奏</a>
                <a href="#" src="./mp3/k/016.寂寞_谢容儿" lrc="./lrc/k/016.寂寞_谢容儿.lrc" sgidx="15" sgfmts="mp3">016.寂寞_谢容儿</a>
                <a href="#" src="./mp3/k/017.寂寞_谢容儿_伴奏" lrc="./lrc/k/017.寂寞_谢容儿_伴奏.lrc" sgidx="16" sgfmts="mp3">017.寂寞_谢容儿_伴奏</a>
                <a href="#" src="./mp3/k/018.越长大越孤单_牛奶咖啡" lrc="./lrc/k/019.越长大越孤单_伴奏.lrc" sgidx="17" sgfmts="mp3">018.越长大越孤单_牛奶咖啡</a>
                <a href="#" src="./mp3/k/019.越长大越孤单_伴奏" lrc="./lrc/k/019.越长大越孤单_伴奏.lrc" sgidx="17" sgfmts="mp3">019.越长大越孤单_伴奏</a>
                <a href="#" src="./mp3/k/Cry On My Shoulder" lrc="./lrc/k/Cry On My Shoulder.lrc" sgidx="15" sgfmts="mp3">Cry On My Shoulder</a><a href="#" src="./mp3/k/Cry_On_My_Shoulder_伴奏R2" lrc="./lrc/k/Cry_On_My_Shoulder_伴奏R2.lrc" sgidx="16" sgfmts="mp3">Cry On My Shoulder 伴奏R2</a><a href="#" src="./mp3/k/diary" lrc="./lrc/k/diary.lrc" sgidx="17" sgfmts="mp3">diary</a><a href="#" src="./mp3/k/nothing_is_gonna_change_my_love_for_you_GlennMedeiros_伴奏" lrc="./lrc/k/nothing_is_gonna_change_my_love_for_you_GlennMedeiros_伴奏.lrc" sgidx="18" sgfmts="mp3">nothing is gonna change my love for you GlennMedeiros 伴奏</a><a href="#" src="./mp3/k/the105days" lrc="./lrc/k/the105days.lrc" sgidx="19" sgfmts="mp3">the105days</a><a href="#" src="./mp3/k/Yomawari" lrc="./lrc/k/Yomawari.lrc" sgidx="20" sgfmts="mp3">Yomawari</a>
                <a href="#" src="./mp3/k/情深说话未曾讲_黎明" lrc="./lrc/k/情深说话未曾讲_黎明.lrc" sgidx="21" sgfmts="mp3">情深说话未曾讲 黎明</a><a href="#" src="./mp3/k/断点_张敬轩_伴奏" lrc="./lrc/k/断点_张敬轩_伴奏.lrc" sgidx="22" sgfmts="mp3">断点 张敬轩 伴奏</a><a href="#" src="./mp3/k/海阔天空" lrc="./lrc/k/海阔天空.lrc" sgidx="23" sgfmts="mp3">海阔天空</a><a href="#" src="./mp3/k/童话_光良_伴奏" lrc="./lrc/k/童话_光良_伴奏.lrc" sgidx="24" sgfmts="mp3">童话 光良 伴奏</a>
                
            </div>
        </div>
    </div>
    <br />
    <div class="sellgirl_player_lrcContainer">
        <ul id="lrclist" class="sellgirl_player_lrc">
            <!-- 保证歌词在正中间 -->
        </ul>
        <!-- <p>无歌词</p> -->
    </div>
<input type='hidden' value='' id='firstSongIdx' />
</div>
<script type="text/javascript">
    $(document).ready(function () {
        //var idxStr = document.getElementById("firstSongIdx").value;
        //var idx = idxStr !== undefined && idxStr !== null && idxStr !== '' ? (parseInt(idxStr) - 1) : null;

        
sellgirl.createMusicPlayer2 = function (audioContainer,opts) {
    if(opts===undefined||opts===null){
        opts={};
    }
    var cachePrev=opts.cachePrev;
    //按钮
    var nextLrcModeBtn = audioContainer.find('#nextLrcModeBtn');

    //缓存
    function sNumber(num, key, defaultNum) {
        if (defaultNum === undefined || undefined === null) { defaultNum = 0; }
        if (num !== null && num !== undefined) {
            localStorage.setItem(key, num.toString());
        }
        return localStorage.getItem(key) == null || localStorage.getItem(key) == 'undefined' ? defaultNum : parseInt(localStorage.getItem(key));
    }
    function sCurIdx(curIdx) {
        return sNumber(curIdx, 'sellgirl_mediaPlayer_curIdx');
    }
    function sPlayMode(playMode) {
        //return sNumber(playMode, 'sellgirl_mediaPlayer_playMode');
        return sNumber(playMode, 'sellgirl_mediaPlayer_playMode', 2); //默认随机播放
    }
    function sLrcMode(lrcMode) {
        return sNumber(lrcMode, 'sellgirl_mediaLrcer_lrcMode', 1);
    }

    var medias = {};
    var curIdx = sCurIdx();
    var playMode = sPlayMode();
    var lrcMode = sLrcMode();

    var lrcJSONCache = {};
    var lrcTimeCache = {}; //歌词对应的时间数组--benjamin20191125
    //var lrcTime = [];//歌词对应的时间数组--benjamin20191125
    // var lrcTitle = '';//歌词标题
    var randomPlayList = [];
    var randomPlayContainer = null;

    function getPlayLis() {//获得播放列表li
        return document.getElementsByClassName('sellgirl_player_list_top')[0].children;
    }

    if (getPlayLis().length - 1 < curIdx) { curIdx = sCurIdx(0); } //当服务器中删除了视频文件时,当前idx可能已经太大了

    function setDefaultBg(oldSrc) {
        var lis = getPlayLis();
        for (var i = 0; i < lis.length; i++) {
//            if (decodeURIComponent('./' + oldSrc.replace(window.location.href.replace(/[^\/]*$/, ''), '')) == lis[i].attributes.getNamedItem('src').nodeValue + '.' + lis[i].attributes.getNamedItem('sgFmts').nodeValue.split(',')[0]) {
            if (decodeURIComponent(oldSrc.replace(window.location.href.replace(/[^\/]*$/, ''), '')) == lis[i].attributes.getNamedItem('src').nodeValue ) {
                lis[i].style.backgroundColor = ''; // 'white';//如果加了白色,会挡住 a:hover时的背景色
            }
        }

    }
    function srcIsVideo(src) {
        var lcSrc = src.toLowerCase();
        //var formats = ['.mp4', '.ogg', '.mkv'];
        var formats = ['mp4', 'mkv']; //改为多source后--20180728
        for (var i = 0; i < formats.length; i++) {
            if (lcSrc.indexOf(formats[i]) > -1) { return true; }
        }
        return false;
    }
    function srcIsFlv(src) {
        var lcSrc = src.toLowerCase();
        var formats = ['flv']; 
        for (var i = 0; i < formats.length; i++) {
            if (lcSrc.indexOf(formats[i]) > -1) { return true; }
        }
        return false;
    }
    function mediaIsStopped(player) {
        return player.videoDom.ended || player.videoDom.paused;
    }
    var videoPlayers={};
    function createVideo(src, isVideo,idx) {
        isVideo = (isVideo !== false); //默认true
        
        alert(cachePrev+ idx);
        var oVideo=JSON.parse(localStorage.getItem(cachePrev+ idx));
        if(null==oVideo||undefined==oVideo){
            alert('no cache');
            //medias[idx] = createVideo(src, isVideo);
            oVideo = document.createElement(isVideo ? "video" : "audio");
            oVideo.autoplay = 'autoplay';
            oVideo.controls = 'controls';
            oVideo.className = 'classAudio';
            oVideo.autobuffer = 'autobuffer';
            oVideo.setAttribute('sellgirlSrc',src);            
            oVideo.addEventListener('ended', function () {
                playNext();
                // localStorage.setItem(cachePrev+ idx,oVideo);
                localStorage.setItem(cachePrev+ idx,JSON.stringify( oVideo));
                debugger;
                console.info(JSON.stringify( oVideo));
                alert('set cache ok');
            });
        }else{
            alert('is cache');
            // medias[idx] = tmp;
            
        }

        // var oVideo = document.createElement(isVideo ? "video" : "audio");
        // oVideo.autoplay = 'autoplay';
        // oVideo.controls = 'controls';
        // oVideo.className = 'classAudio';
        // oVideo.autobuffer = 'autobuffer';
        // oVideo.setAttribute('sellgirlSrc',src);
        // //oVideo.src = src;
        // oVideo.addEventListener('ended', function () {
        //     playNext();
        // });

        var result={
            play:function(){oVideo.play();},
            pause:function(){oVideo.pause();},
            videoDom:oVideo,
            isFlv:false,
            removeSource:function(){
                var childs = oVideo.childNodes;
                for (var i = childs.length - 1; i >= 0; i--) {
                    oVideo.removeChild(childs[i]);
                }
            },
            onTimeUpdate:function(fun){
              oVideo.ontimeupdate=fun;
            },
            onSeeked:function(fun){
              oVideo.onseeked=fun;
            },
            currentTime:function(){
                return oVideo.currentTime;
            },
            setCurrentTime:function(t){
                return oVideo.currentTime=t;
            }
        };
        videoPlayers[src]=result;
        return result;
    }
    //var flvPlayers={};
    //需要引用flvjs
    function createFlv(src) {
        var oVideo = document.createElement("video");                        
        oVideo.autoplay = 'autoplay';
        oVideo.controls = 'controls';
        oVideo.className = 'classAudio';
        oVideo.autobuffer = 'autobuffer';
        oVideo.setAttribute('sellgirlSrc',src);
        //oVideo.src = src;
        
        var flvPlayer = flvjs.createPlayer({
            type: 'flv',
            // url: 'http://example.com/flv/video.flv'
            url: src+'.flv'
        });
        flvPlayer.attachMediaElement(oVideo);
        flvPlayer.load();
        //flvPlayer.play();
        oVideo.addEventListener('ended', function() {
            playNext();
        });
//        return oVideo;
        var result={
            play:function(){flvPlayer.play();},
            pause:function(){flvPlayer.pause();},
            videoDom:oVideo,
            isFlv:true,
            removeSource:function(){
                var childs = oVideo.childNodes;
                for (var i = childs.length - 1; i >= 0; i--) {
                    oVideo.removeChild(childs[i]);
                }
            },
            onTimeUpdate:function(fun){
              oVideo.ontimeupdate=fun;
            },
            onSeeked:function(fun){
              oVideo.onseeked=fun;
            },
            currentTime:function(){
                return oVideo.currentTime;
            },
            setCurrentTime:function(t){
                return oVideo.currentTime=t;
            }
        };
        videoPlayers[src]=result;
        return result;
    }
    var lastTimeIsFlv=false;
    function liClick(li) {

        var idx = parseInt(li.attributes.getNamedItem('sgIdx').nodeValue);
        sCurIdx(idx);
        if (idx === curIdx && medias[idx]) {//当重播时
            if (!medias[idx].ended) { medias[idx].setCurrentTime ( 0); }
            medias[idx].play();
            return;
        }

        var aus = document.getElementsByClassName('classAudio');
        var videoLayer = document.getElementsByClassName('videoLayer')[0];
        
        if (aus && aus.length > 0) {
            //var originSrc=aus[0].getAttribute('sellgirlSrc');
            var originSrc=aus[0].attributes.getNamedItem('sellgirlSrc').nodeValue;
            var originPlayer=videoPlayers[originSrc];
            //setDefaultBg(aus[0].src);//iphone不支持此属性currentSrc
            //setDefaultBg(aus[0].childNodes[0].src); //iphone不支持此属性currentSrc.改为多个source之后要用第一个子节点的url去找当前播放地址
            //setDefaultBg(lastTimeIsFlv?aus[0].src:aus[0].childNodes[0].src); //iphone不支持此属性currentSrc.改为多个source之后要用第一个子节点的url去找当前播放地址
            setDefaultBg(originSrc); //iphone不支持此属性currentSrc.改为多个source之后要用第一个子节点的url去找当前播放地址

            if (!mediaIsStopped(originPlayer)) { originPlayer.pause(); }
            if (!medias[curIdx]) { medias[curIdx] = aus[0]; }
            videoLayer.removeChild(aus[0]);
        }

        var src = li.attributes.getNamedItem('src').nodeValue;
        //debugger;
        var sgFmts=li.attributes.getNamedItem('sgFmts').nodeValue;
        //var isVideo = srcIsVideo(src);
        var isVideo = srcIsVideo(sgFmts); //改为多source之后--20180728
        var isFlv=srcIsFlv(sgFmts);
        if (!medias[idx]) {
            if(typeof(flvjs)==='undefined'||(!isFlv)){
                // //alert('isVideo');
                // var tmp=JSON.parse(localStorage.getItem(cachePrev+ idx));
                // if(null==tmp||undefined==tmp){
                //     alert('no cache');
                //     medias[idx] = createVideo(src, isVideo);
                // }else{
                //     alert('is cache');
                //     medias[idx] = tmp;
                // }
                medias[idx] = createVideo(src, isVideo, idx);
            }else{
                medias[idx] = createFlv(src);
            }
        } else {
            if (isVideo) {//iphone上,如果不重新load的话,有时切换到不同格式时就会显示不了video的图像,没办法先加这句;华为手机上,即使load了也没用,视频直接停了,所以干脆重新创建element
                var oldVideo = medias[idx];
                alert('1111');
                // medias[idx] = createVideo(src);
                medias[idx] = createVideo(src, isVideo, idx);
                delete oldVideo;
            } else if (medias[idx].currentTime() != 0) {
                medias[idx].setCurrentTime(0);
            }
            var currentPlayer=videoPlayers[src];
            if (mediaIsStopped(currentPlayer)) { 
                currentPlayer.play();
            }
        }
        
        //为了兼容多种浏览器，同时声称多个source节点--20180728var childs = f.childNodes; 
        medias[idx].removeSource();
    
        var fmts = li.attributes.getNamedItem('sgFmts').nodeValue.split(',');
        var mimeType={
            mp4:'video/mp4'
        };
        
        if(!isFlv){
            for (var i = 0; i < fmts.length; i++) {
                var oSource = document.createElement("source");
                oSource.src = src + '.' + fmts[i];
                //oSource.type = 'audio/' + fmts[i];
                oSource.type = mimeType[fmts[i]]!=undefined?mimeType[fmts[i]]:'audio/' + fmts[i];
                medias[idx].videoDom.appendChild(oSource);
            }
        }

        //videoLayer.appendChild(medias[idx]);
        videoLayer.appendChild(medias[idx].videoDom);
        curIdx = idx;
        li.style.backgroundColor = 'lightblue';

        //显示歌词--benjamin20191125
        //debugger;
        if (!isVideo) {
            function showLrc() {

                var ul = $("#lrclist")[0]; //获取ul
                $("#lrclist").empty();
                var i = 0;
                var lrcJSON = lrcJSONCache[li.innerHTML];
                // debugger;
                if (null === lrcJSON||undefined===lrcJSON) { return;}
                $.each(lrcJSON, function (key, value) {//遍历lrc
                    // lrcTime[i++] = parseFloat(key.substr(1,3)) * 60 + parseFloat(key.substring(4,10));//00:00.000转化为00.000格式
                    ul.innerHTML += "<li><p>" + ((lrcJSON[key] === null || lrcJSON[key] === undefined || lrcJSON[key] === "") ? "&nbsp;" : lrcJSON[key]) + "</p></li>"; //ul里填充歌词
                });
                //lrcTime[lrcTime.length] = lrcTime[lrcTime.length-1] + 3;//如不另加一个结束时间，到最后歌词滚动不到最后一句


                var currentLine = 0; //当前播放到哪一句歌词了
                var currentTime; //当前播放的时间
                //var audio = document.getElementById("audio");
                //var ppxx;//保存ul的translateY值
                var $li = $("#lrclist>li"); //获取所有li
                //debugger;
                var lrcTime = lrcTimeCache[li.innerHTML];
                var lastJ = -2;
                medias[idx].onTimeUpdate( function () {//audio时间改变事件
                    //debugger;
                    currentTime = medias[idx].currentTime();
                    //debugger;
                    for (var j = currentLine, len = lrcTime.length; j < len; j++) {//这样写的话，liclick时需要重置currentLine为0，索性从0开始找吧
                        //for (var j=0, len=lrcTime.length; j<len; j++){
                        if (
                                (currentTime < lrcTime[j + 1]
                                  || j + 1 >= lrcTime.length//最后一行时
                                )
                                && (currentTime >= lrcTime[j]
                                  || j === 0//第一行时(如果没这句,当歌词第一句的时间比较大时,就一直不满足了
                                )
                               ) {
                            currentLine = j;
                            if (//lastJ!==j&&//这样的话，liclick时lastJ没有重置
                                    (!$li.eq(currentLine).hasClass('on')) &&
                                    (!$pf.stringIsNullOrWhiteSpace($li.get(currentLine).innerText))) {
                                // debugger;
                                //ppxx = 250-(currentLine*32);
                                // ul.style.transform = "translateY("+ppxx+"px)";
                                // debugger;
                                // ul.scrollTop=ppxx;
                                //$('.sellgirl_player_lrcContainer').scrollTop(currentLine*32);

                                var ppxx = $li.get(currentLine).getBoundingClientRect().top
                                      - $li.get(0).getBoundingClientRect().top;
                                //$('.sellgirl_player_lrcContainer').animate({scrollTop:currentLine*32},200);
                                $('.sellgirl_player_lrcContainer').animate({ scrollTop: ppxx }, 200);

                                // console.log(ppxx);
                                // ul.scrollTop="1000px";
                                // $li.get(currentLine-1).className="";
                                $li.removeClass('on');
                                // console.log("on"+currentLine);
                                $li.get(currentLine).className = "on";

                                lastJ = j;
                            }
                            break;
                        }
                    }
                });
                medias[idx].onSeeked(function () {//audio进度更改后事件
                    currentTime = medias[idx].currentTime();
                    // console.log("  off"+currentLine);
                    $li.get(currentLine).className = "";
                    for (var k = 0, len = lrcTime.length; k < len; k++) {
                        if (
                                (currentTime < lrcTime[k + 1]
                                  || k + 1 >= lrcTime.length//最后一行时
                                )
                                && currentTime >= lrcTime[k]
                               ) {
                            currentLine = k;
                            lastJ = -2;
                            break;
                        }
                    }
                });
            }
            if (lrcJSONCache[li.innerHTML] === undefined ) {
                //var lrcUtl = encodeURIComponent(li.attributes.getNamedItem('lrc').nodeValue);
                if (null!==li.attributes.getNamedItem('lrc')&&'' !== li.attributes.getNamedItem('lrc').nodeValue) {

                    var lrcUtl = encodeURI(li.attributes.getNamedItem('lrc').nodeValue);
                    //alert(lrcUtl);
                    $.get(lrcUtl, null, function (data) {
                        if (data !== undefined && data !== null && data !== '') {
                            // $("#lrclist").css('transform','translateY(26px)');

                            var lrcArray = data.indexOf('\r\n') > -1 ? data.split('\r\n') : data.split('\n');// linux系统是\n换行(如github的web系统里面)

                            var lrcTitle = '';
                            var lrcJSON = {};
                            var lrcJSONArray = [];
                            // debugger;
                            lrcJSON['[00:00.00]'] = '';//顺序对后面$.foreach是有影响的
                            function isTimeLine(s) {
                                return s !== null && s !== undefined && s.length > 9 && s[0] === '[' && s[3] === ':' && s[9] === ']';
                            }
                            function setLineToTime(line) {//为了适应压缩版的歌词(一行有多个时间标签)
                                var timeArr = [];
                                while (isTimeLine(line)) {
                                    timeArr.push(line.substr(0, 10));
                                    line = line.substr(10, line.length - 10);
                                }
                                //                            if(isTimeLine(line)){
                                //                                lrcJSON[line.substr(0,10)] = line.substr(10,line.length-10);
                                //                            }
                                for (var i = 0; i < timeArr.length; i++) {
                                    lrcJSON[timeArr[i]] = line;
                                    lrcJSONArray.push({ t: timeArr[i], l: line });
                                }
                            }
                            function keyToTime(key) {
                                return parseFloat(key.substr(1, 3)) * 60 + parseFloat(key.substring(4, 10));
                            }
                            for (var j = 0; j < lrcArray.length; j++) {
                                //                            if (lrcArray[j].indexOf(']') === 9) {
                                if (isTimeLine(lrcArray[j])) {
                                    ////                                var lrcRow = lrcArray[j].split(']');
                                    ////                                lrcJSON[lrcRow[0] + ']'] = lrcRow[1];
                                    //                                lrcJSON[lrcArray[j].substr(0,10)] = lrcArray[j].substr(10,lrcArray[j].length-10);
                                    setLineToTime(lrcArray[j]);
                                } else {
                                    lrcTitle += lrcArray[j];
                                }
                            }
                            //if (lrcJSON['[00:00.00]'] === undefined && lrcJSON['[00:00:00]'] === undefined) {
                            lrcJSON['[00:00.00]'] = lrcTitle;
                            lrcJSONArray.push({ t: '[00:00.00]', l: lrcTitle });
                            //                        
                            //                            var aa=$.sort(lrcJSON, function (a,b){
                            //                                return parseInt(a.replace(':','').replace('.',''))-parseInt(b.replace(':','').replace('.',''));
                            //                            });

                            try {
                                //压缩版歌词需要重新排序--benjamin 20201205
                                var lrcJSONArraySort = lrcJSONArray.sort(function (a, b) {
                                    //return parseInt(a.t.replace(':','').replace('.',''))-parseInt(b.t.replace(':','').replace('.',''));
                                    return keyToTime(a.t) - keyToTime(b.t);
                                });
                                lrcJSON = {};
                                for (var i = 0; i < lrcJSONArraySort.length; i++) {
                                    lrcJSON[lrcJSONArraySort[i].t] = lrcJSONArraySort[i].l;
                                }
                            } catch (e) {

                            }


                            lrcJSONCache[li.innerHTML] = lrcJSON;

                            var lrcTime = []; //歌词对应的时间数组
                            i = 0;
                            $.each(lrcJSON, function (key, value) {//遍历lrc
                                //lrcTime[i++] = parseFloat(key.substr(1, 3)) * 60 + parseFloat(key.substring(4, 10)); //00:00.000转化为00.000格式
                                lrcTime[i++] = keyToTime(key);
                                // ul.innerHTML += "<li><p>"+lrcJSON[key]+"</p></li>";//ul里填充歌词
                            });
                            lrcTimeCache[li.innerHTML] = lrcTime;
                            showLrc();
                            setLrcModel(nextLrcModeBtn[0]);

                        } else {
                            delete lrcJSONCache[li.innerHTML];
                            delete lrcTimeCache[li.innerHTML];
                            var ul = $("#lrclist")[0]; //获取ul
                            $("#lrclist").empty();
                            ul.innerHTML = "<li>无歌词</li>";

                        }
                    });
                }
            } else {
                showLrc();
            }

        }

        //下载按钮,因为发现只有华为浏览器上的html5 mp3播放器才带下载按钮,但很多浏览器都不带下载按钮 -- benjamin 20230200
        var downloadFileBtn=audioContainer.find('#downloadFileBtn');
        if(null!=downloadFileBtn&&undefined!=downloadFileBtn&&downloadFileBtn.length>0){
            downloadFileBtn[0].setAttribute("href",src+'.'+(fmts.length>0?fmts[0]:'mp3'));
            downloadFileBtn[0].setAttribute("download",li.innerHTML);
            
        }
    }
    function play(idx) {
        var lis = getPlayLis();
        if (!lis[idx]) { idx = 0 };
        liClick(lis[idx]);
    }
    function playNext() {
        // debugger;       
        switch (playMode) {
            case 0:
                play(curIdx + 1);
                break;
            case 1:
                play(curIdx);
                break;
            case 2: //Random 和传统随机不同,随机抽取,全部轮一遍后再重复
                // if(randomPlayList.length<1){
                //     var lis = getPlayLis();
                //     for (var i = 0; i < lis.length; i++) {
                //         randomPlayList.push(i);
                //     }
                // }
                // play($pf.listRandomTake(randomPlayList,1,true)[0]);

                play(randomPlayContainer.randomTake(1));
                setPlayModelLabel(document.getElementsByClassName('sellgirl_player_list_toolbar')[0].children[0]);
                break;
            default:
                break;
        }
    }
    function setPlayModelLabel(dom) {
        switch (playMode) {
            case 0:
                dom.innerHTML = "&lt;顺序播放&gt;";
                break;
            case 1:
                dom.innerHTML = "&lt;单曲循环&gt;";
                break;
            case 2:
                dom.innerHTML = "&lt;随机播放(rest:" + randomPlayContainer.getRestCount() + ")&gt;";
                break;
            default:
                break;
        }
    }
    function setLrcModel(dom) {
        switch (lrcMode) {
            case 0:
                dom.innerHTML = "&lt;多行歌词&gt;";
                break;
            case 1:
                dom.innerHTML = "&lt;单行歌词&gt;";
                break;
            default:
                break;
        }

        switch (lrcMode) {
            case 0:
                $('.sellgirl_player_lrcContainer').height('auto');
                break;
            case 1:
                var lrcLi = $('.sellgirl_player_lrc li').eq(0);
                if (lrcLi.length > 0) {
                    $('.sellgirl_player_lrcContainer').height(lrcLi.height() + 21); //21是偏差值
                }
                break;
            default:
                break;
        }
    }
    var isSongListClosed = false;
    function expandSongList(useAnimate) {
        var playerListTop = $('.sellgirl_player_list_top');
        function setTopHeight(height) {
            if (useAnimate !== false) {
                playerListTop.animate({ height: height + 'px' }, 200);
            } else {
                playerListTop.height(height + 'px');
            }
        }
        var rect = playerListTop[0].getBoundingClientRect();
        var h = $(window).height() - rect.top - 5; //5为偏差值,否则会多1个滚动条
        playerListTop.height("auto");
        var autoRect = playerListTop[0].getBoundingClientRect();
        // debugger;
        playerListTop.height("0px");
        if (autoRect.height > h) {
            // playerListTop.height(h);
            // playerListTop.animate({height:h+'px'},200);
            setTopHeight(h);
        } else {
            //playerListTop.height(autoRect.height);
            // playerListTop.animate({height:autoRect.height+'px'},200);
            setTopHeight(autoRect.height);
        }
        // $('.sellgirl_player_list_top').animate({height:"100px"},200);
        isSongListClosed = false;
    }
    function closeSongList(useAnimate) {
        if (useAnimate !== false) {
            $('.sellgirl_player_list_top').animate({ height: '0px' }, 200);
        } else {
            $('.sellgirl_player_list_top').height('0px');
        }
        isSongListClosed = true;
    }
    function selectSong(dom) {
        var playerListTop = $('.sellgirl_player_list_top');

        if (!isSongListClosed) {
            closeSongList();
            dom.innerHTML = "<选歌...>";
        } else {
            expandSongList();
            dom.innerHTML = "<收起列表>";
        }
    }

    function nextPlayMode(dom) {
        // playMode = playMode > 0 ? 0 : playMode + 1; //2种模式时
        playMode = playMode > 1 ? 0 : playMode + 1; //3种模式时
        sPlayMode(playMode);
        setPlayModelLabel(dom);
    }
    function nextLrcMode(dom) {
        lrcMode = lrcMode > 0 ? 0 : lrcMode + 1; //3种模式时
        sLrcMode(lrcMode);
        setLrcModel(dom);
    }

    return {
        ready: function () {
            //监听
            audioContainer.find('#nextPlayModeBtn').click(function () {
                nextPlayMode(this);
            });
            audioContainer.find('#playNextBtn').click(function () {
                playNext(this);
            });
            audioContainer.find('#selectSongBtn').click(function () {
                selectSong(this);
            });
            nextLrcModeBtn.click(function () {
                nextLrcMode(this);
            });
            audioContainer.find('.sellgirl_player_list_top a').click(function () {
                liClick(this);
            });
            

            //        if (oldOnLoad) { oldOnLoad(); }

            var lis = getPlayLis();


            var idxs = [];
            for (var i = 0; i < lis.length; i++) {
                idxs.push(i);

                //为了不用在dom上写sgidx--benjamin20241130
                lis[i].setAttribute('sgidx',i.toString());
            }
            randomPlayContainer = $pf.listRandomTakeContainer(idxs);

            //liClick(lis[curIdx]);
            var hasIdx=opts.idx!==undefined&&opts.idx!==null&&opts.idx<lis.length&&opts.idx>-1;
            var songName=hasIdx?lis[opts.idx].innerHTML:"";
            var tmpPlayFirstTime=function(){
            //debugger;
            
                if(hasIdx){
                    play(opts.idx);
                }else{
                    playNext(); //默认下一首--benjamin20191130
                }
            };
            
//            if(sellgirl.isOnMobile){
//            
//            }
            //var tmpMask=new sellgirl.showMask("<p class='sellgirlStartPlayBtn' style='cursor:pointer;'>点击开始播放</p><br /><p class='sellgirlDonotPlayBtn' style='cursor:pointer;color:red;font-size:8px'>不开始播放</p>",{opacity:0.5});
            //var tmpMask=new sellgirl.showMask("<p class='sellgirlStartPlayBtn' style='cursor:pointer;'>点击开始播放</p><br /><br /><p class='sellgirlDonotPlayBtn' style='cursor:pointer;color:red;font-size:8px'>不开始播放</p>",{opacity:0.5});
            var tmpMaskStr="";
            if(hasIdx){
                tmpMaskStr+="<p>"+songName+"</p>";   
                tmpMaskStr+="<p class='sellgirlStartPlayBtn' style='cursor:pointer;'>点击开始播放</p>";
                var tmpMask=new sellgirl.showMask(tmpMaskStr,{opacity:0.5});

                $('.sellgirlStartPlayBtn').parent().parent().click(function(){
                    tmpPlayFirstTime();
                    tmpMask.close();
                });
            }else{
            //var tmpMask=new sellgirl.showMask("<p class='sellgirlStartPlayBtn' style='cursor:pointer;'>点击开始播放</p>",{opacity:0.5});
            }         
//            $('.sellgirlDonotPlayBtn').click(function(event){
//                sellgirl.stopPropagation(event);
//                tmpMask.close();
//            });

            if (lis.length < 5) {
                $('#selectSongBtn').hide();
                expandSongList(false);
            } else {
                closeSongList(false);
            }
            // liClick(getPlayLis()[curIdx]);
            setPlayModelLabel(document.getElementsByClassName('sellgirl_player_list_toolbar')[0].children[0]);
            //setLrcModel(document.getElementById('nexLrcModeBtn'));第一次加载歌词是异步的
        }
    };
};

        var urlParam = $pf.getRequest();
        var idx = urlParam.idx !== undefined && urlParam.idx !== null && urlParam.idx !== '' ? (parseInt(urlParam.idx) - 1) : null;
        sellgirl.createMusicPlayer2($('.audioContainer'), { idx: idx ,cachePrev:'test'}).ready();
    });
</script>


</body>
</html>
